name: Build nvdiffrast Wheels (CUDA128+Py312+Win)

on: [workflow_dispatch]

jobs:
  wheel:
    # 和torch_scatter保持一致：仅Windows 2022非ARM
    runs-on: windows-2022

    strategy:
      fail-fast: false
      matrix:
        # 完全对齐torch_scatter的目标环境
        os: [windows-2022]
        python-version: ['3.12']
        torch-version: [2.7.0]
        cuda-version: ['cu128']

    steps:
      # 1. 拉取代码（和torch_scatter一致）
      - uses: actions/checkout@v2

      # 2. 配置Python（和torch_scatter一致）
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      # 3. 升级pip/编译工具（和torch_scatter一致）
      - name: Upgrade pip
        run: |
          pip install --upgrade setuptools
          pip install wheel ninja pybind11  # 新增nvdiffrast需要的pybind11

      # 4. 安装CUDA 12.8（完全复用torch_scatter的安装脚本）
      - name: Install CUDA ${{ matrix.cuda-version }}
        if: ${{ matrix.cuda-version != 'cpu' }}
        run: |
          bash .github/workflows/cuda/${{ matrix.cuda-version }}-${{ runner.os }}.sh

      # 5. 安装PyTorch 2.7.0+cu128（和torch_scatter完全一致）
      - name: Install PyTorch ${{ matrix.torch-version }}+${{ matrix.cuda-version }}
        run: |
          pip install torch==${{ matrix.torch-version }}+${{ matrix.cuda-version }} --index-url https://download.pytorch.org/whl/${{ matrix.cuda-version }}
          python -c "import torch; print('PyTorch:', torch.__version__)"
          python -c "import torch; print('CUDA:', torch.version.cuda)"

      # 6. （可选）Windows下PyTorch补丁（和torch_scatter一致，避免编译报错）
      - name: Patch PyTorch static constexpr on Windows
        if: ${{ runner.os == 'Windows' }}
        run: |
          Torch_DIR=`python -c 'import os; import torch; print(os.path.dirname(torch.__file__))'`
          sed -i '31,38c\
          TORCH_API void lazy_init_num_threads();' ${Torch_DIR}/include/ATen/Parallel.h
        shell: bash

      # 7. 编译nvdiffrast的CUDA版本（适配Windows+CUDA128）
      - name: Build wheel for GPU (CUDA128)
        if: ${{ matrix.cuda-version != 'cpu' }}
        run: |
          # 加载CUDA环境（复用torch_scatter的环境脚本）
          source .github/workflows/cuda/${{ matrix.cuda-version }}-${{ runner.os }}-env.sh
          # 强制CUDA编译，指定输出目录
          FORCE_CUDA=1 python setup.py bdist_wheel --dist-dir=dist
        shell: bash

      # 8. 上传编译好的wheel（和torch_scatter一致，方便下载）
      - name: Upload wheel as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nvdiffrast-cp312-cu128-win2022
          path: dist/*.whl
